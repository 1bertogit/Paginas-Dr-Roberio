---
interface Props {
  /** Form title */
  title?: string;
  /** Form subtitle */
  subtitle?: string;
  /** Emailit list/form endpoint */
  emailitEndpoint?: string;
  /** Success message */
  successMessage?: string;
  /** Button text */
  buttonText?: string;
  /** Show name field */
  showName?: boolean;
  /** Show phone field */
  showPhone?: boolean;
  /** Compact mode (inline) */
  compact?: boolean;
}

const {
  title = 'Receba novidades',
  subtitle = 'Cadastre-se para receber atualizações exclusivas.',
  emailitEndpoint = import.meta.env.PUBLIC_EMAILIT_ENDPOINT || '',
  successMessage = 'Inscrito com sucesso!',
  buttonText = 'Inscrever',
  showName = false,
  showPhone = false,
  compact = false,
} = Astro.props;
---

<section id="newsletter" class:list={["px-[5vw] py-12 max-w-2xl mx-auto", { "py-6": compact }]}>
  {!compact && (
    <div class="text-center mb-8">
      <h2 class="text-2xl sm:text-3xl font-bold mb-3">{title}</h2>
      <p class="text-slate-400">{subtitle}</p>
    </div>
  )}

  <form
    id="emailit-form"
    class:list={[
      "grid gap-4",
      { "sm:grid-cols-[1fr_auto] sm:gap-3": compact && !showName && !showPhone }
    ]}
    data-endpoint={emailitEndpoint}
  >
    {showName && (
      <div>
        <label for="emailit-name" class="block text-sm font-medium text-slate-300 mb-2">
          Nome
        </label>
        <input
          type="text"
          id="emailit-name"
          name="name"
          class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-text placeholder:text-slate-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition"
          placeholder="Seu nome"
        />
      </div>
    )}

    <div>
      {!compact && (
        <label for="emailit-email" class="block text-sm font-medium text-slate-300 mb-2">
          E-mail *
        </label>
      )}
      <input
        type="email"
        id="emailit-email"
        name="email"
        required
        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-text placeholder:text-slate-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition"
        placeholder="seu@email.com"
      />
    </div>

    {showPhone && (
      <div>
        <label for="emailit-phone" class="block text-sm font-medium text-slate-300 mb-2">
          WhatsApp
        </label>
        <input
          type="tel"
          id="emailit-phone"
          name="phone"
          class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-text placeholder:text-slate-500 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent transition"
          placeholder="(11) 99999-9999"
        />
      </div>
    )}

    <button
      type="submit"
      class:list={[
        "px-6 py-3 bg-accent text-bg font-semibold rounded-xl hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed",
        { "w-full": !compact, "whitespace-nowrap": compact }
      ]}
    >
      {buttonText}
    </button>

    <p id="emailit-status" class="text-center text-sm hidden col-span-full"></p>
  </form>
</section>

<script define:vars={{ successMessage }}>
  const form = document.getElementById('emailit-form');
  const status = document.getElementById('emailit-status');
  const endpoint = form?.dataset.endpoint;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
      // Track with Posthog if available
      if (window.trackConversion) {
        window.trackConversion('newsletter_signup', { email: data.email });
      }

      // Track with GTM dataLayer if available
      if (window.dataLayer) {
        window.dataLayer.push({
          event: 'newsletter_signup',
          email: data.email
        });
      }

      if (endpoint) {
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error('Subscription failed');
      }

      status.textContent = successMessage;
      status.className = 'text-center text-sm text-green-400 col-span-full';
      status.classList.remove('hidden');
      form.reset();

    } catch (error) {
      status.textContent = 'Erro ao inscrever. Tente novamente.';
      status.className = 'text-center text-sm text-red-400 col-span-full';
      status.classList.remove('hidden');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });
</script>
